# chef-managed
global
  log         127.0.0.1 local2

  chroot      <%= @chroot %>
  pidfile     <%= @pidfile %>
  maxconn     4000
  user        haproxy
  group       haproxy
  daemon

  # turn on stats unix socket
  stats socket <%= @chroot %>/stats

  defaults
  mode                    http
  log                     global
  option                  httplog
  option                  dontlognull
  option http-server-close
  option forwardfor       except 127.0.0.0/8
  option                  redispatch
  retries                 3
  timeout http-request    10s
  timeout queue           1m
  timeout connect         10s
  timeout client          1m
  timeout server          1m
  timeout http-keep-alive 10s
  timeout check           10s
  maxconn                 3000

<% @fes.each do |name, fe| %>
  frontend  <%=  "#{name}  #{fe[:ip]}:#{fe[:port]}" %>
  default_backend             <%= fe[:default_backend] %>

<% end %>
<% @bes.each do |name, be| %>
backend <%= name %>
  <% if be[:options] %>
  <% be[:options].each do |option| %>
  <%= option %>
  <% end %>
  <% end %>


  <% be[:servers].each do |server| %>
  <% server.each do |s_name, s| %>
  server  <%= s_name %>  <%= s[:socket] %> <%= s[:options].join(' ') %>
  <% end %>
  <% end %>
<% end %>
